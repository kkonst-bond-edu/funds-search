name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Free Space
        run: sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Create venv
        run: |
          uv venv .venv
          . .venv/bin/activate
          python -V
          which python

      - name: Install dependencies (venv)
        run: |
          . .venv/bin/activate

          # Core deps
          uv pip install langgraph==0.2.60 langchain-core langchain-openai

          # CPU torch
          uv pip install torch --index-url https://download.pytorch.org/whl/cpu

          # Test/runtime deps used in repo
          uv pip install pytest pytest-mock pytest-asyncio fastapi uvicorn numpy python-dotenv pydantic structlog

      - name: Create minimal pytest config (ignore pyproject.toml)
        run: |
          cat > ci_pytest.ini <<'INI'
          [pytest]
          INI

      - name: Add repo root into site-packages via .pth (no PYTHONPATH)
        run: |
          . .venv/bin/activate
          python - <<'PY'
          import site, pathlib
          sp = site.getsitepackages()[0]
          pth = pathlib.Path(sp) / "funds_search_repo.pth"
          pth.write_text(str(pathlib.Path.cwd().resolve()) + "\n")
          print("Wrote:", pth)
          print("Repo root:", pathlib.Path.cwd().resolve())
          print("Site-packages:", sp)
          PY

      - name: Sanity check: prove which langgraph is imported
        run: |
          . .venv/bin/activate

          python -c "import sys,importlib.util,pathlib; \
          print('PYTHON:',sys.version); \
          print('EXE:',sys.executable); \
          print('CWD:',pathlib.Path().resolve()); \
          print('sys.path[0]:',sys.path[0]); \
          spec=importlib.util.find_spec('langgraph'); \
          print('langgraph spec:',spec); \
          print('langgraph origin:', getattr(spec,'origin',None)); \
          print('langgraph submodule_search_locations:', getattr(spec,'submodule_search_locations',None)); \
          root=pathlib.Path.cwd(); \
          hits=list(root.rglob('langgraph.py'))+list(root.rglob('langgraph.pyc'))+list(root.rglob('langgraph/__init__.py')); \
          print('repo shadow hits:', [str(p) for p in hits[:100]])"

          python -c "from langgraph.graph import StateGraph, END; print('OK: langgraph.graph import works')"

      - name: Run tests (from /tmp to avoid cwd shadowing)
        env:
          OPENAI_API_KEY: "mock-key"
        run: |
          . .venv/bin/activate
          cd /tmp

          python -m pytest -v \
            -c "$GITHUB_WORKSPACE/ci_pytest.ini" \
            --import-mode=importlib \
            --ignore "$GITHUB_WORKSPACE/services/embedding-service" \
            "$GITHUB_WORKSPACE/tests" \
            "$GITHUB_WORKSPACE/apps/api/tests"