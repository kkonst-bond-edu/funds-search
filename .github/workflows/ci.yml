name: CI
on: [push, pull_request]

jobs:
  test:
    name: Pure Logic Validation
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space
        run: sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Surgical Installation
        run: |
          python -m pip install --upgrade pip
          
          # 1. Rename any local shadowing files/dirs (The "Ghost" Killer)
          find . -maxdepth 4 -name "langgraph*" -not -path "*site-packages*" -exec mv {} {}_local_backup \;
          
          # 2. Install core logic stack (No heavy ML)
          pip install --no-cache-dir langgraph==0.2.60 "langchain-core>=0.3.0" langchain-openai
          pip install --no-cache-dir numpy python-dotenv pydantic==2.10.5 pytest pytest-asyncio pytest-mock structlog fastapi uvicorn
          
          # 3. Create a global mock for Torch to prevent ImportErrors
          mkdir -p tests
          echo "import sys; from unittest.mock import MagicMock; m = MagicMock(); sys.modules['torch'] = m; sys.modules['torch.nn'] = m; sys.modules['transformers'] = m; sys.modules['docling'] = m" > tests/conftest.py

      - name: Run Pytest
        env:
          PYTHONPATH: ${{ github.workspace }}
          OPENAI_API_KEY: "mock-key"
        run: |
          # Verify langgraph is now clean
          python3 -c "import langgraph.graph; print(f'âœ“ Langgraph is safe at: {langgraph.__file__}')"
          
          # Run pytest excluding the heavy embedding-service
          python3 -m pytest -v --import-mode=importlib --ignore=services/embedding-service
