name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup Disk (Aggressive)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
          df -h

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Surgical Installation
        run: |
          python -m pip install --upgrade pip
          
          # 1. СНАЧАЛА ставим только ядро LangGraph. Без кэша.
          pip install --no-cache-dir langgraph==0.2.60 "langchain-core>=0.3.0"
          
          # 2. Мгновенная проверка. Если это упадет - проблема в самой библиотеке (маловероятно).
          python3 -c "import langgraph.graph; print('✅ Langgraph core is ALIVE')"
          
          # 3. Ставим только то, что нужно для запуска API и тестов (БЕЗ TORCH)
          pip install --no-cache-dir fastapi uvicorn pydantic==2.10.5 pytest pytest-asyncio pytest-mock structlog
          
          # 4. Создаем "заглушку" для torch, чтобы тесты не падали на импорте
          mkdir -p mock_libs
          echo "import sys; from unittest.mock import MagicMock; m = MagicMock(); sys.modules['torch'] = m; sys.modules['torch.nn'] = m; sys.modules['transformers'] = m" > mock_libs/sitecustomize.py

      - name: Run Pytest (The Reckoning)
        env:
          PYTHONPATH: "mock_libs:${{ github.workspace }}"
          OPENAI_API_KEY: "mock-key"
        run: |
          echo "--- 1. Check for imposters ---"
          # Если этот поиск что-то найдет, мы это увидим
          find . -name "langgraph" -not -path "*site-packages*"
          
          echo "--- 2. Execute Tests ---"
          # Запускаем pytest. Он подхватит наш mock_libs/sitecustomize.py и проигнорирует отсутствие Torch
          python3 -m pytest -v --import-mode=importlib