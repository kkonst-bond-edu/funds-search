name: CI
on: [push, pull_request]

jobs:
  test:
    name: Surgical Logic Validation
    runs-on: ubuntu-latest
    steps:
      - name: Hard Cleanup
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Isolated Installation
        run: |
          python -m pip install --upgrade pip
          
          # 1. Install critical core into a PRIVATE folder to avoid shadowing
          mkdir -p ./lib_clean
          pip install --no-cache-dir --target=./lib_clean langgraph==0.2.60 "langchain-core>=0.3.0" langchain-openai
          
          # 2. Install only necessary support libraries
          pip install --no-cache-dir numpy python-dotenv pydantic==2.10.5 pytest pytest-asyncio pytest-mock structlog fastapi uvicorn

      - name: Run Pytest (The Reckoning)
        env:
          # Force Python to look into our 'lib_clean' first, then the repo
          PYTHONPATH: "${{ github.workspace }}/lib_clean:${{ github.workspace }}"
          OPENAI_API_KEY: "mock-key"
        run: |
          echo "--- Diagnostic ---"
          python3 -c "import sys; sys.path.insert(0, './lib_clean'); import langgraph; print(f'âœ“ Langgraph is at: {langgraph.__file__}')"
          
          # Run tests, ignore the heavy embedding service that needs torch
          python3 -m pytest -v --import-mode=importlib --ignore=services/embedding-service