name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Free Space
        run: sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          uv pip install --system langgraph==0.2.60 langchain-core langchain-openai
          uv pip install --system torch --index-url https://download.pytorch.org/whl/cpu
          uv pip install --system pytest pytest-mock pytest-asyncio fastapi uvicorn numpy python-dotenv pydantic structlog

      # Ключевой шаг: ловим "затенение" ДО pytest
      - name: Sanity check langgraph import (must be site-packages)
        run: |
          python3 - << 'PY'
          import os, sys, pathlib
          import importlib.metadata as md

          # 1) быстрый детектор самого частого кейса
          if pathlib.Path("langgraph.py").exists():
            raise SystemExit("FATAL: repo has ./langgraph.py which shadows the langgraph package. Rename/remove it.")

          print("PYTHON:", sys.version)
          print("CWD:", os.getcwd())

          # 2) проверяем, что установлен именно pip-пакет langgraph
          print("langgraph dist version:", md.version("langgraph"))

          # 3) проверяем, что импортируется пакет и у него есть graph
          import langgraph
          print("langgraph imported from:", getattr(langgraph, "__file__", None))
          from langgraph.graph import StateGraph, END
          print("OK: from langgraph.graph import StateGraph, END")
          PY

      - name: Run Pytest
        env:
          OPENAI_API_KEY: "mock-key"
        run: |
          export PYTHONPATH="${{ github.workspace }}"
          python3 -m pytest -v \
            --rootdir="${{ github.workspace }}" \
            -c /dev/null \
            --import-mode=importlib \
            --ignore=services/embedding-service \
            tests/ apps/api/tests/