name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Manual Disk Cleanup
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Lightweight Installation
        run: |
          python -m pip install --upgrade pip
          
          # Create a lightweight requirements file without the heavy ML stuff
          grep -vE "torch|transformers|docling|nvidia" requirements.txt > req_light.txt
          
          pip install --no-cache-dir -r req_light.txt
          pip install --no-cache-dir langgraph==0.2.60 "langchain-core>=0.3.0" pytest pytest-mock pytest-asyncio structlog fastapi uvicorn
          
          # If your code imports torch but doesn't use it in tests, we install a tiny mock
          pip install --no-cache-dir unittest-xml-reporting 

      - name: Verify and Run
        env:
          OPENAI_API_KEY: "mock-key"
          PYTHONPATH: ${{ github.workspace }}
        run: |
          # Kill any local shadows one last time
          find . -iname "langgraph.py" -delete
          
          # Run pytest. If it fails on missing torch import, we'll know.
          python3 -m pytest -v --import-mode=importlib

  docker-build:
    name: Docker Build Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build API Image
        run: docker build -f apps/api/Dockerfile -t api:test .
