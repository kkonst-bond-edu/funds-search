name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          # 1. Install core stack via uv
          uv pip install --system langgraph==0.2.60 "langchain-core>=0.3.0" langchain-openai langchain-community
          
          # 2. Install Torch CPU (critical to avoid No Space Left on Device)
          uv pip install --system torch --index-url https://download.pytorch.org/whl/cpu
          
          # 3. Install the rest, excluding heavy ML to stay safe
          grep -vE "torch|transformers|docling|nvidia|triton" requirements.txt > req_light.txt
          uv pip install --system -r req_light.txt
          uv pip install --system pytest pytest-mock pytest-asyncio structlog fastapi uvicorn numpy python-dotenv

      - name: Nuclear Shadow Purge
        run: |
          echo "--- Searching for the imposter langgraph.py ---"
          # This command finds and kills the exact file causing the 'is not a package' error
          find . -maxdepth 5 -name "langgraph.py" -not -path "*site-packages*" -print -delete
          find . -maxdepth 5 -name "langgraph" -type d -not -path "*site-packages*" -not -path "./.git*" -print -exec rm -rf {} +

      - name: Run Pytest
        env:
          PYTHONPATH: ${{ github.workspace }}
          OPENAI_API_KEY: "mock-key"
        run: |
          # Verify health one last time
          python3 -c "import langgraph.graph; print(f'âœ… Final check passed: {langgraph.__file__}')"
          
          # Run pytest ignoring the embedding-service (which needs real torch)
          python3 -m pytest -v --import-mode=importlib --ignore=services/embedding-service
