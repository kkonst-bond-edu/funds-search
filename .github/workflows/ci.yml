name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Core Logic & API Tests
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 10240
          remove-dotnet: 'true'
          remove-android: 'true'

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install and Purge
        run: |
          pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu
          pip install --no-cache-dir -r requirements.txt || true
          pip install --no-cache-dir langgraph==0.2.60 "langchain-core>=0.3.0" pytest pytest-mock pytest-asyncio
          
          echo "--- Searching for shadowing files ---"
          # This script finds exactly where Python sees 'langgraph' and kills it if it's in the repo
          python3 -c "
          import importlib.util, os, shutil
          spec = importlib.util.find_spec('langgraph')
          if spec and spec.origin and 'site-packages' not in spec.origin:
              print(f'ðŸš¨ SHADOW FOUND AT: {spec.origin}')
              if os.path.isfile(spec.origin): os.remove(spec.origin)
              else: shutil.rmtree(os.path.dirname(spec.origin) if spec.origin.endswith('__init__.py') else spec.origin)
          "
          # Double check for files we might have missed
          find . -iname "langgraph.py" -not -path "*site-packages*" -delete
          find . -type d -name "langgraph" -not -path "*site-packages*" -exec rm -rf {} +

      - name: Run Pytest
        env:
          OPENAI_API_KEY: "mock-key"
        run: |
          # Force Python to look ONLY at site-packages for the core libraries
          SITE_PKGS=$(python3 -c 'import site; print(site.getsitepackages()[0])')
          export PYTHONPATH="$SITE_PKGS:${{ github.workspace }}"
          python3 -m pytest -v --import-mode=importlib

  docker-build:
    name: Docker Build Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build API Image
        run: docker build -f apps/api/Dockerfile -t api:test .
