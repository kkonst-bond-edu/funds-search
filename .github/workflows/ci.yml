name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Free Space
        run: sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # --- clean venv (NO --system) ---
      - name: Create venv
        run: |
          uv venv .venv
          echo "${GITHUB_WORKSPACE}/.venv/bin" >> "$GITHUB_PATH"
          python -V

      - name: Install dependencies
        run: |
          python -m pip uninstall -y langgraph || true
          uv pip install \
            langgraph==0.2.60 langchain-core langchain-openai \
            pytest pytest-mock pytest-asyncio fastapi uvicorn numpy python-dotenv pydantic structlog
          uv pip install torch --index-url https://download.pytorch.org/whl/cpu
          python -m pip show langgraph

      # --- HARD GUARANTEE: langgraph must be a PACKAGE and must have langgraph.graph ---
      - name: Preflight: verify langgraph resolution
        run: |
          python - <<'PY'
          import importlib.util
          spec = importlib.util.find_spec("langgraph")
          print("langgraph spec:", spec)
          if spec is None:
            raise SystemExit("langgraph is NOT installed")

          print("origin:", spec.origin)
          print("submodule_search_locations:", spec.submodule_search_locations)

          # If this is None -> Python resolved langgraph as a single module file (shadowing / wrong dist)
          if spec.submodule_search_locations is None:
            raise SystemExit(
              "langgraph resolved as a NON-package module. "
              "This is almost always caused by a shadowing langgraph.py in the repo "
              "or some wrong module named langgraph earlier in sys.path."
            )

          from langgraph.graph import StateGraph, END
          print("OK: langgraph.graph import works")
          PY

          echo "Searching workspace for shadowing langgraph.py..."
          if find "$GITHUB_WORKSPACE" -type f -name "langgraph.py" -print | grep -q .; then
            echo "::error::Found a shadowing langgraph.py in the workspace. Rename/delete it."
            exit 1
          fi

      - name: Run Pytest
        env:
          OPENAI_API_KEY: "mock-key"
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}"

          python -m pytest -v \
            --rootdir "${GITHUB_WORKSPACE}" \
            --cache-dir "${RUNNER_TEMP}/pytest_cache" \
            --import-mode=importlib \
            --ignore=services/embedding-service \
            tests/ apps/api/tests/