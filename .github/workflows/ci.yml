name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Final Fix
    runs-on: ubuntu-latest
    env:
      # Настройка UV для скорости и экономии места
      UV_SYSTEM_PYTHON: 1
      UV_CACHE_DIR: /tmp/.uv-cache
    
    steps:
      # 1. Очистка диска (Обязательно для ML проектов)
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
          sudo docker image prune --all --force
          df -h

      - uses: actions/checkout@v4

      # 2. Ставим UV (он спасет ситуацию)
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "requirements.txt"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. Установка зависимостей (Умная стратегия)
      - name: Install Dependencies via uv
        run: |
          # Создаем легкий список требований БЕЗ тяжелых библиотек, чтобы uv мог их разрешить отдельно
          grep -vE "torch|transformers|docling|nvidia|triton" requirements.txt > req_core.txt
          
          # Сначала ставим LangGraph (гарантируем его целостность)
          uv pip install langgraph==0.2.60 "langchain-core>=0.3.0" langchain-openai langchain-community
          
          # Ставим PyTorch CPU (Экономия 5 ГБ места!)
          uv pip install torch --index-url https://download.pytorch.org/whl/cpu
          
          # Ставим остальные библиотеки (API, Pydantic и т.д.)
          uv pip install -r req_core.txt
          uv pip install pytest pytest-mock pytest-asyncio structlog fastapi uvicorn numpy python-dotenv

      # 4. Проверка среды перед тестами
      - name: Verify Environment
        run: |
          python3 -c "import langgraph.graph; import torch; print(f'✅ SUCCESS: Langgraph loaded from {langgraph.__file__}')"

      # 5. Запуск тестов
      - name: Run Pytest
        env:
          PYTHONPATH: ${{ github.workspace }}
          OPENAI_API_KEY: "mock-key"
          DEEPSEEK_API_KEY: "mock-key"
          PINECONE_API_KEY: "mock-key"
        run: |
          # Игнорируем embedding-service, если он требует GPU-зависимостей, которых нет
          # Но благодаря torch-cpu он должен пройти, если там только логика
          python3 -m pytest -v --import-mode=importlib