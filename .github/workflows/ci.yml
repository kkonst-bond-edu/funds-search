name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Space (The Only Way)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 18000 # Оставляем 18ГБ под систему, остальное под код
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-docker-images: 'true'

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Isolated Installation
        run: |
          python -m pip install --upgrade pip
          
          # 1. СНАЧАЛА ставим только критический стек LangGraph без кэша
          pip install --no-cache-dir langgraph==0.2.60 "langchain-core>=0.3.0" langchain-openai langchain-community
          
          # 2. Проверяем импорт СРАЗУ (если упадет тут - значит диск или библиотека битая)
          python3 -c "import langgraph.graph; print('✅ Langgraph installed successfully')"
          
          # 3. Ставим остальные зависимости по одной, чтобы видеть где кончится место
          pip install --no-cache-dir pytest pytest-mock pytest-asyncio structlog fastapi uvicorn
          
          # 4. Ставим ТЯЖЕЛЫЙ блок (Torch) в самом конце и только CPU версию
          pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu || echo "Torch failed, but we continue"

      - name: Debug and Run
        env:
          PYTHONPATH: ${{ github.workspace }}
          OPENAI_API_KEY: "mock-key"
        run: |
          echo "--- sys.path inside pytest ---"
          # Создаем временный скрипт отладки
          echo "import sys; import langgraph; print(f'Langgraph path: {langgraph.__file__}'); print(f'Path: {sys.path}')" > debug_path.py
          python3 debug_path.py
          
          # Запускаем pytest с ПОЛНОЙ изоляцией
          # -p no:cacheprovider убирает создание лишних папок .pytest_cache
          python3 -m pytest -v --import-mode=importlib -p no:cacheprovider