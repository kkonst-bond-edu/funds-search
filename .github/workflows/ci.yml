name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 15360
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Extreme Cleanup & Install
        run: |
          # 1. Strip heavy ML from requirements to guarantee disk space
          grep -vE "torch|transformers|docling|nvidia|triton" requirements.txt > req_light.txt
          
          # 2. Install core stack
          pip install --no-cache-dir -r req_light.txt
          pip install --no-cache-dir langgraph==0.2.60 "langchain-core>=0.3.0" pytest pytest-mock pytest-asyncio structlog fastapi uvicorn
          
          # 3. MOCK TORCH (The Space Saver)
          # This prevents ModuleNotFoundError in embedding tests without installing 2GB of data
          mkdir -p mock_libs
          echo "class Mock: pass" > mock_libs/torch.py
          echo "import sys; sys.modules['torch'] = Mock()" >> mock_libs/torch.py
          
          # 4. KILL ALL LOCAL LANGGRAPH SHADOWS
          # Search everywhere for any file/folder named langgraph and destroy it
          python3 -c "
          import os, shutil
          for root, dirs, files in os.walk('.'):
              for name in dirs + files:
                  if 'langgraph' in name.lower() and 'site-packages' not in root:
                      path = os.path.join(root, name)
                      print(f'ðŸš¨ Killing shadow: {path}')
                      if os.path.isdir(path): shutil.rmtree(path)
                      else: os.remove(path)
          "

      - name: Run Pytest (The Final Victory)
        env:
          OPENAI_API_KEY: "mock-key"
          PYTHONPATH: ".:./mock_libs"
        run: |
          # Verify that langgraph is now a real package from site-packages
          python3 -c 'import langgraph.graph; print(f"âœ“ Success: {langgraph.__file__}")'
          
          # Run pytest with import-mode isolation
          python3 -m pytest -v --import-mode=importlib
