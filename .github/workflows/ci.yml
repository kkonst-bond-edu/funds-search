name: CI
on: [push, pull_request]

jobs:
  test:
    name: Logic & API Validation
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 10240
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          
          # 1. Install critical stack while disk is fresh
          pip install --no-cache-dir langgraph==0.2.60 "langchain-core>=0.3.0"
          
          # 2. Install lightweight CPU torch (critical for space)
          pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu
          
          # 3. Install remaining requirements
          pip install --no-cache-dir -r requirements.txt || true
          pip install --no-cache-dir pytest pytest-mock pytest-asyncio fastapi uvicorn structlog

      - name: Run Pytest
        env:
          OPENAI_API_KEY: "mock-key"
          DEEPSEEK_API_KEY: "mock-key"
          PINECONE_API_KEY: "mock-key"
        run: |
          # The key fix: put site-packages at the START of PYTHONPATH
          SITE_PKGS=$(python3 -c 'import site; print(site.getsitepackages()[0])')
          export PYTHONPATH="$SITE_PKGS:${{ github.workspace }}"
          
          echo "--- Environment Check ---"
          python3 -c "import langgraph.graph; print(f'âœ“ Langgraph found at: {langgraph.__file__}')"
          
          # Run pytest recursively across the project
          python3 -m pytest -v --import-mode=importlib