name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
    
    - name: Import smoke check - API
      run: |
        python -c "import apps.api.main"
    
    - name: Import smoke check - CV Processor
      run: |
        export PYTHONPATH=$PWD:$PYTHONPATH
        # Use importlib to load module from file path (handles hyphen in directory name)
        python -c "import importlib.util; spec = importlib.util.spec_from_file_location('main', 'services/cv-processor/main.py'); module = importlib.util.module_from_spec(spec); spec.loader.exec_module(module); print('✓ CV Processor imports successful')"
    
    - name: Import smoke check - Embedding Service
      run: |
        export PYTHONPATH=$PWD:$PYTHONPATH
        # Use importlib to load module from file path (handles hyphen in directory name)
        python -c "import importlib.util; spec = importlib.util.spec_from_file_location('main', 'services/embedding-service/main.py'); module = importlib.util.module_from_spec(spec); spec.loader.exec_module(module); print('✓ Embedding Service imports successful')"
    
    - name: Import smoke check - Web UI
      run: |
        python -c "import apps.web_ui.app"
    
    - name: Import smoke check - VC Worker
      run: |
        export PYTHONPATH=$PWD:$PYTHONPATH
        # Use importlib to load module from file path (handles hyphen in directory name)
        python -c "import importlib.util; spec = importlib.util.spec_from_file_location('main', 'services/vc-worker/main.py'); module = importlib.util.module_from_spec(spec); spec.loader.exec_module(module); print('✓ VC Worker imports successful')"
    
    - name: Run tests
      run: |
        pytest tests/ -v --tb=short
    
    - name: Run API tests
      run: |
        if [ -d "apps/api/tests" ]; then
          pytest apps/api/tests/ -v --tb=short
        fi
    
    - name: Run embedding service tests
      run: |
        if [ -d "services/embedding-service/tests" ]; then
          pytest services/embedding-service/tests/ -v --tb=short
        fi

  docker-build-smoke:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: api
            dockerfile: apps/api/Dockerfile
            port: 8000
            health_path: /health
          - name: cv-processor
            dockerfile: services/cv-processor/Dockerfile
            port: 8001
            health_path: /health
          - name: embedding-service
            dockerfile: services/embedding-service/Dockerfile
            port: 8001
            health_path: /health
          - name: web-ui
            dockerfile: apps/web_ui/Dockerfile
            port: 8501
            health_path: /
          - name: vc-worker
            dockerfile: services/vc-worker/Dockerfile
            port: 8003
            health_path: /health
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image for ${{ matrix.service.name }}
      run: |
        docker build -f ${{ matrix.service.dockerfile }} -t ${{ matrix.service.name }}:test .
    
    - name: Run container for ${{ matrix.service.name }}
      run: |
        docker run -d \
          --name ${{ matrix.service.name }}-test \
          -p ${{ matrix.service.port }}:${{ matrix.service.port }} \
          ${{ matrix.service.name }}:test
    
    - name: Wait for service to start
      run: |
        echo "Waiting 10 seconds for ${{ matrix.service.name }} to start..."
        sleep 10
    
    - name: Check health endpoint for ${{ matrix.service.name }}
      run: |
        if [ "${{ matrix.service.name }}" = "web-ui" ]; then
          # Streamlit doesn't have /health, use curl to check if UI is available
          attempt=1
          while [ $attempt -le 5 ]; do
            if curl -s -f http://localhost:${{ matrix.service.port }} > /dev/null 2>&1; then
              echo "✓ Web UI is up and responding on port ${{ matrix.service.port }}"
              exit 0
            fi
            echo "Waiting for Web UI (attempt $attempt/5)..."
            sleep 5
            attempt=$((attempt + 1))
          done
          echo "✗ Web UI did not become available after 5 attempts"
          docker logs ${{ matrix.service.name }}-test
          exit 1
        else
          # For other services, check /health endpoint
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${{ matrix.service.port }}${{ matrix.service.health_path }} || echo "000")
            if [ "$response" = "200" ]; then
              echo "✓ ${{ matrix.service.name }} health check passed (HTTP $response)"
              break
            else
              if [ $attempt -eq $max_attempts ]; then
                echo "✗ ${{ matrix.service.name }} health check failed after $max_attempts attempts (HTTP $response)"
                docker logs ${{ matrix.service.name }}-test
                exit 1
              else
                echo "⚠ Attempt $attempt/$max_attempts: Health check returned HTTP $response, retrying..."
                sleep 2
                attempt=$((attempt + 1))
              fi
            fi
          done
        fi
    
    - name: Cleanup container
      if: always()
      run: |
        docker stop ${{ matrix.service.name }}-test || true
        docker rm -f ${{ matrix.service.name }}-test || true

  docs-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install markdownlint-cli
      run: |
        npm install -g markdownlint-cli
    
    - name: Check markdown files
      run: |
        markdownlint "**/*.md" --ignore node_modules --ignore .git || true
        # Note: Using || true to not fail the build on formatting issues
        # Remove || true if you want strict formatting enforcement
    
    - name: Check for required documentation files
      run: |
        required_docs=("README.md")
        for doc in "${required_docs[@]}"; do
          if [ ! -f "$doc" ]; then
            echo "Warning: Required documentation file $doc is missing"
          else
            echo "✓ Found $doc"
          fi
        done
    
    - name: Validate markdown syntax (basic check)
      run: |
        # Basic markdown validation: check for common issues
        find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" -print0 | while IFS= read -r -d '' file; do
          echo "Checking $file..."
          # Check for unclosed code blocks
          code_blocks=$(grep -c '```' "$file" 2>/dev/null || true)
          # Default to 0 if code_blocks is empty or not a number
          code_blocks=${code_blocks:-0}
          # Ensure it's a valid integer for arithmetic expansion
          if [ "$code_blocks" -eq "$code_blocks" ] 2>/dev/null; then
            if [ $((code_blocks % 2)) -ne 0 ]; then
              echo "Warning: $file may have unclosed code blocks (found $code_blocks code block markers)"
            fi
          fi
          # Check for basic structure (at least some content)
          if [ ! -s "$file" ]; then
            echo "Warning: $file is empty"
          fi
        done
