name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Free Space
        run: sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          uv pip install --system langgraph==0.2.60 langchain-core langchain-openai
          uv pip install --system torch --index-url https://download.pytorch.org/whl/cpu
          uv pip install --system pytest pytest-mock pytest-asyncio fastapi uvicorn numpy python-dotenv pydantic structlog

      - name: Run Pytest in Isolation
        env:
          OPENAI_API_KEY: "mock-key"
        run: |
          # 1. Сначала проверяем, где python видит langgraph ДО запуска pytest
          python3 -c "import langgraph; print(f'--- DEBUG: Langgraph source: {langgraph.__file__}')"
          
          # 2. ТРЮК: Запускаем pytest, явно указывая, что текущая папка НЕ является пакетом
          # Мы используем '-c /dev/null', чтобы игнорировать любые настройки в pyproject.toml, 
          # которые могут ломать импорты
          export PYTHONPATH="${{ github.workspace }}"
          python3 -m pytest -v \
            -c /dev/null \
            --import-mode=importlib \
            --ignore=services/embedding-service \
            tests/ apps/api/tests/
