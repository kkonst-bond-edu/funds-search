name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      VENV_PY: ${{ github.workspace }}/.venv/bin/python

    steps:
      - name: Free Space
        run: sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Create venv
        run: uv venv .venv --seed

      - name: Install dependencies (venv)
        run: |
          "$VENV_PY" -V
          "$VENV_PY" -m pip -V
          "$VENV_PY" -m pip install -U pip

          # hard reinstall to avoid any weird preinstalled shadowing
          uv pip install --python "$VENV_PY" --no-cache-dir --force-reinstall "langgraph==0.2.60"

          uv pip install --python "$VENV_PY" --no-cache-dir \
            langchain-core langchain-openai \
            pytest pytest-mock pytest-asyncio \
            fastapi uvicorn numpy python-dotenv pydantic structlog

          uv pip install --python "$VENV_PY" --no-cache-dir \
            torch --index-url https://download.pytorch.org/whl/cpu

      - name: Create minimal pytest config
        run: printf "[pytest]\n" > ci_pytest.ini

      - name: Sanity check - langgraph import
        run: |
          "$VENV_PY" -c "import importlib.util, sys, pathlib; print('EXE:', sys.executable); print('CWD:', pathlib.Path().resolve()); spec = importlib.util.find_spec('langgraph'); print('langgraph spec:', spec); print('origin:', getattr(spec, 'origin', None) if spec else None); print('locations:', getattr(spec, 'submodule_search_locations', None) if spec else None)"
          "$VENV_PY" -c "import langgraph; print('langgraph.__file__:', getattr(langgraph, '__file__', None)); print('is_pkg:', hasattr(langgraph, '__path__'))"
          "$VENV_PY" -c "from langgraph.graph import StateGraph, END; print('OK: langgraph.graph import works')"

      - name: Run tests
        env:
          OPENAI_API_KEY: "mock-key"
        run: |
          "$VENV_PY" -m pytest -v \
            -c ci_pytest.ini \
            --import-mode=importlib \
            --ignore services/embedding-service \
            tests apps/api/tests