name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      VENV_PY: ${{ github.workspace }}/.venv/bin/python

    steps:
      - name: Free Space
        run: sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Create venv
        run: uv venv .venv

      - name: Install dependencies (venv)
        run: |
          "$VENV_PY" -V
          "$VENV_PY" -m pip -V

          # Make sure langgraph is clean + exact version
          "$VENV_PY" -m pip uninstall -y langgraph || true
          uv pip install --python "$VENV_PY" --no-cache-dir --force-reinstall "langgraph==0.2.60"

          # Other deps
          uv pip install --python "$VENV_PY" --no-cache-dir "langchain-core" "langchain-openai"
          uv pip install --python "$VENV_PY" --no-cache-dir "torch" --index-url https://download.pytorch.org/whl/cpu
          uv pip install --python "$VENV_PY" --no-cache-dir pytest pytest-mock pytest-asyncio fastapi uvicorn numpy python-dotenv pydantic structlog

      - name: Create minimal pytest config (ignore pyproject.toml)
        run: |
          printf "[pytest]\n" > ci_pytest.ini

      - name: Add repo root into site-packages via .pth (no PYTHONPATH)
        run: |
          "$VENV_PY" -c "import site, pathlib; sp=site.getsitepackages()[0]; pth=pathlib.Path(sp)/'funds_search_repo.pth'; pth.write_text(str(pathlib.Path.cwd().resolve())+'\n'); print('Wrote:', pth); print('Repo root:', pathlib.Path.cwd().resolve()); print('Site-packages:', sp)"

      - name: Sanity check: show langgraph resolution
        run: |
          "$VENV_PY" -c "import importlib.util, sys, pathlib; print('EXE:', sys.executable); print('CWD:', pathlib.Path().resolve()); spec=importlib.util.find_spec('langgraph'); print('langgraph spec:', spec); print('origin:', getattr(spec,'origin',None)); print('locations:', getattr(spec,'submodule_search_locations',None))"
          "$VENV_PY" -c "import langgraph; print('langgraph.__file__:', getattr(langgraph,'__file__',None)); print('is_pkg:', hasattr(langgraph,'__path__'))"
          "$VENV_PY" -c "from langgraph.graph import StateGraph, END; print('OK: langgraph.graph import works')"

      - name: Run tests (from /tmp to avoid cwd shadowing)
        env:
          OPENAI_API_KEY: "mock-key"
        run: |
          cd /tmp
          "$VENV_PY" -m pytest -v \
            -c "$GITHUB_WORKSPACE/ci_pytest.ini" \
            --import-mode=importlib \
            --ignore "$GITHUB_WORKSPACE/services/embedding-service" \
            "$GITHUB_WORKSPACE/tests" \
            "$GITHUB_WORKSPACE/apps/api/tests"