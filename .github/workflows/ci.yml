name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Free Space
        run: sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Logic Stack
        run: |
          uv pip install --system langgraph==0.2.60 langchain-core langchain-openai
          uv pip install --system torch --index-url https://download.pytorch.org/whl/cpu
          uv pip install --system pytest pytest-mock pytest-asyncio fastapi uvicorn numpy python-dotenv pydantic

      - name: Nuclear Purge of Shadows
        run: |
          # Physically remove any local folder named langgraph that isn't the real library
          find . -name "langgraph" -type d -not -path "*site-packages*" -print -exec rm -rf {} +
          find . -name "langgraph.py" -not -path "*site-packages*" -print -delete

      - name: Run Pytest (Shielded)
        env:
          OPENAI_API_KEY: "mock-key"
        run: |
          # Get the real system path for site-packages
          SITE_PKGS=$(python3 -c 'import site; print(site.getsitepackages()[0])')
          # Force python to look at site-packages FIRST, then the repo
          export PYTHONPATH="$SITE_PKGS:${{ github.workspace }}"
          
          echo "--- DEBUG: WHERE IS LANGGRAPH? ---"
          python3 -c "import langgraph; print(f'REAL PATH: {langgraph.__file__}')"
          
          python3 -m pytest -v --import-mode=importlib --ignore=services/embedding-service
